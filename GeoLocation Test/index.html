<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Get Location</title>
	<!-- jQuery -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>
</head>
<body>
	<a href="#" id="get_location">Get Location</a>
	<div id="map">
		<iframe id="google_map" width="425" height="350" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.com?output=embed" frameborder="0"></iframe>
	</div>
	<div id="location_details">
		
	</div>
	
	<script src="js/geoposition.js"></script>
	<script src="js/modernizr.js"></script>
	<script>

	//VIDEO 1
	//=========================================================================================
		/*var c = function(position) {
			var latitude = position.coords.latitude,
			longitude = position.coords.longitude
			coords = latitude + ", " + longitude;

			document.getElementById("google_map").setAttribute("src", "https://maps.google.com/?q=" + coords + "&z=16&output=embed");

			document.getElementById("location_details").innerHTML = 
			"<h2> Your Coordinates </h2>" + 
			"<p>" + coords + "</p>";

		}

		document.getElementById("get_location").onclick = function() {
			navigator.geolocation.getCurrentPosition(c);
			return false;
		}*/

	//VIDEO 2
	//=========================================================================================
		/*var moment = require("moment");*/

		//moment.js function which gets the current date
		var getCurrentDate = () => {
			var currentDate = moment().utc().format("MM/d/YYYY");
			return currentDate;
		};

		//moment.js function which gets the current time
		var getCurrentTime = () => {
			var currentTime = moment().utc().format("H:mm:ss");
			return currentTime;
		};

		//function which gets the current users location. Has an optional parameter for repetition
		var getLocation = (repeater) => {

			//Function which runs if getting the users location was successful
			var c = function(position) {

				//stores coordinates into variables
				var latitude = position.coords.latitude,
				longitude = position.coords.longitude,
				accuracy = position.coords.accuracy,
				coords = latitude + ", " + longitude;

				//Updates google map on page with the current location
				document.getElementById("google_map").setAttribute("src", "https://maps.google.com/?q=" + coords + "&z=16&output=embed");

				//stores variables into an object
				var userLocation = {
					"userName": "username",
					"date": getCurrentDate(),
					"time": getCurrentTime(),
					"coordinates": coords,
					"latitude": latitude,
					"longitude": longitude,
					"accuracy": accuracy
				};

				//post request which passes in the current users information into the database and returns that information
				$.post("api/new/userTimeAndLocation", userLocation, 'json')
				.done(function(response) {});

				//if optional repeater parameter exists, run the repeater function
				if (repeater) {
					repeater();
				}

			};

			//Function to get the current location. If succesfull, runs function C. If error, runs function E.
			navigator.geolocation.getCurrentPosition(c, e, {
				enableHighAccuracy: true,
				maximumAge: 60000,
				timeout: 2000
			});
			return false;
		};

		var e = function(error) {
			if (error.code === 1 ) {
				alert("unable to get location");
			} else if (error.code === 2) {
				alert("Internet connection failed.");
			} else if (error.code === 3) {
				alert("connection timed out");
			}
		}

		$("#get_location").on("click", function() {
			getLocation();
		});

		//function which repeats get location for a set amount of time and a set number of times
		var repeater = ((duration, quantity) => {
			var counter = 0;
			var repeatLocation = setInterval(() => {
				getLocation();
				counter++;
				if (counter >= quantity) {
					clearInterval(repeatLocation);
				}
			}, duration);
		});

		//function to call the database and get other users who are near you
		var getProximity = ((distance) => {

			//Function which runs if getting the users location was successful
			var c = function(position) {

				//stores coordinates in variables
				var latitude = position.coords.latitude,
				longitude = position.coords.longitude,
				accuracy = position.coords.accuracy,
				coords = latitude + ", " + longitude;

				//stores variables into an object
				var data = {
				"latitude": latitude,
				"longitude": longitude,
				"distance": distance
				};

				//post request which passes in the current users coordinates and returns users near those coordinates
				$.post("/api/proximityUsers", data, "json")
				.done(function(response) {


					var res = Object.keys(response[0]); //converts the response object into an array
					var resLength = res.length; //gets the array length

					//loops through each item in the response and does something
					for (var i = 0; i < resLength; i++) { 
						console.log("PROXIMITY USER " + i);
						console.log("User Name: " + response[0][i].userName);
						console.log("Date: " + response[0][i].date);
						console.log("Time: " + response[0][i].time);
						console.log("Coordinates: " + response[0][i].coordinates);
						console.log("Latitude: " + response[0][i].latitude);
						console.log("Longitude: " + response[0][i].longitude);
						console.log("Accuracy: " + response[0][i].accuracy + " feet");
						console.log("Distance in Miles: " + response[0][i].distanceMiles + " miles");
						console.log("Distance in Feet: " + response[0][i].distanceFeet + " feet");
						console.log("\n");
					};

					/*var length = response[0][0].length;//finds the length of the response

					console.log("PROXIMITY USERS");
					console.log(length);
					console.log("User Name: " + response[0][10].userName);
					console.log("Date: " + response[0][0].date);
					console.log("Time: " + response[0][0].time);
					console.log("Coordinates: " + response[0][0].coordinates);
					console.log("Latitude: " + response[0][0].latitude);
					console.log("Longitude: " + response[0][0].longitude);
					console.log("Accuracy: " + response[0][0].accuracy + " feet");
					console.log("Distance in Miles: " + response[0][0].distanceMiles + " miles");
					console.log("Distance in Feet: " + response[0][0].distanceFeet + " feet");
					console.log("\n");*/

					/*var counter = 0;
					userLocations.forEach(function(proximityUser) {

						console.log(proximityUser);
					console.log("PROXIMITY USER" + counter);
					console.log("User Name: " + proximityUser.userName);
					console.log("Date: " + proximityUser.date);
					console.log("Time: " + proximityUser.time);
					console.log("Coordinates: " + proximityUser.coordinates);
					console.log("Latitude: " + proximityUser.latitude);
					console.log("Longitude: " + proximityUser.longitude);
					console.log("Accuracy: " + proximityUser.accuracy + " feet");
					console.log("Distance in Miles: " + proximityUser.distanceMiles + " miles");
					console.log("Distance in Feet: " + proximityUser.distanceFeet + " feet");
					console.log("\n");

					counter++;
					});*/
				});
			};

			//function which runs if the browser cannot get the users location
			var e = function(error) {
				if (error.code === 1 ) { //error code 1 is when the user does not give us permission to get their location
					alert("unable to get location");
				} else if (error.code === 2) {
					alert("Internet connection failed."); //error code 2 is when there is no internet connection
				} else if (error.code === 3) {
					alert("connection timed out"); //error code 3 is when the connection times out
				}
			};

			//Function to get the current location. If succesfull, runs function C. If error, runs function E.
			navigator.geolocation.getCurrentPosition(c, e, {
				enableHighAccuracy: true,
				maximumAge: 60000,
				timeout: 2000
			});
			return false;

		});

		$(document).ready(() => {
			//gets the users location and repeats it. Parameter 1 is how many miliseconds to repeat, and parameter 2 is how many times to repeat
			getLocation(repeater(60000, 1));

			//gets the users location and finds other users in the database within a distance of whatever feet is passed into the function
			getProximity(30);
		})

		
	//VIDEO 3
	//=========================================================================================

		/*if (!Modernizr.geolocation) {
			alert("Geolocation Not Supported");
		} else {
			var c = function(position) {
				var latitude = position.coords.latitude,
				longitude = position.coords.longitude,
				accuracy = position.coords.accuracy,
				coords = latitude + ", " + longitude;



				document.getElementById("google_map").setAttribute("src", "https://maps.google.com/?q=" + coords + "&z=16&output=embed");

				document.getElementById("location_details").innerHTML = 
				"<h2> Your Coordinates </h2>" + 
				"<p>" + coords + "</p>" +
				"<p> Accuracy: " + accuracy + " feet</p>";

			};

			var e = function(error) {
				if (error.code === 1 ) {
					alert("unable to get location");
				} else if (error.code === 2) {
					alert("Internet connection failed.");
				} else if (error.code === 3) {
					alert("connection timed out");
				}
			}

			document.getElementById("get_location").onclick = function() {
				navigator.geolocation.getCurrentPosition(c, e, {
					enableHighAccuracy: true,
					maximumAge: 60000,
					timeout: 500
				});
				return false;
			};
		}*/

	//VIDEO 4 - Geoposition.js
	//=========================================================================================
		/*document.getElementById("get_location").onclick = function() {
			var success = function(position) {
				var latitude = position.coords.latitude,
				longitude = position.coords.longitude,
				coords = latitude + "," + longitude;

				alert(coords);
			}

			var error = function() {
				alert("geolocation not supported");
			}

			if (geoPosition.init()) {
				geoPosition.getCurrentPosition(success, error);
			}
			
			return false;
		};*/
	</script>
</body>
</html>